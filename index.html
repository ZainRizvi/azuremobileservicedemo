<!DOCTYPE html>
<html>
    <head>
        <title></title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

        <script type="text/javascript" src="http://ecn.dev.virtualearth.net/mapcontrol/mapcontrol.ashx?v=7.0"></script>
        <script type="text/javascript" src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.6.2.min.js"></script>
        <script type="text/javascript">
            var map = null;
            var userLocation = null;

            function GetMap() {

                map = new Microsoft.Maps.Map(document.getElementById("mapDiv"),
                                 { credentials: "AvXb0M3CEYHOkLKJCr9tGJyXLzuTbi8hqLPCkLB7Cd6MvvYXMytLru8-Ykm5iRN2",
                                     center: new Microsoft.Maps.Location(45.5, -122.5),
                                     mapTypeId: Microsoft.Maps.MapTypeId.road,
                                     zoom: 7
                                 });
                //var center = map.getCenter();
                //var pin = new Microsoft.Maps.Pushpin(center, { text: '1', draggable: true });
                //map.entities.push(pin);
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(locateSuccess, locateFail);
                }
                else {
                    alert('Geo location is not supported');
                }
            }

            function locateSuccess(loc) {
                userLocation = new Microsoft.Maps.Location(loc.coords.latitude, loc.coords.longitude);
                map.setView({ center: userLocation, zoom: 15 });
                var locationArea = drawCircle(userLocation);
                var pin = new Microsoft.Maps.Pushpin(userLocation, { text: '1', draggable: false });
                map.entities.push(pin);
                map.entities.push(locationArea);
                var client = new WindowsAzure.MobileServiceClient(
                        "https://jkmobileservice.azure-mobile.net/",
                        "igrhDCBgNDHWlggSIAYmAZSlXTllup93");
                var item = { text: "Awesome item10",
                    userName: "Jae Kim",
                    imageName: "my dog",
                    longitude: loc.coords.longitude.toString(),
                    latitude: loc.coords.latitude.toString()
                }
                var itemTable = client.getTable("Item");
                itemTable.insert(item);
                client.invokeApi("getmessagesbylocation", {
                    body: null,
                    method: "GET",
                    parameters: { 
                        longitude: loc.coords.longitude, 
                        latitude: loc.coords.latitude, 
                        distance: 10000 
                    }
                }).done(function (results) {
                    console.log("results = ", results.result.length);
                    for (var i = 0; i < results.result.length; i++) {
                        console.log("result = " + results.result[i].longitude + " " + results.result[i].latitude + " " + results.result[i].text);
                        var messageLocation = new Microsoft.Maps.Location(results.result[i].latitude, results.result[i].longitude);
                        var newPin = new Microsoft.Maps.Pushpin(messageLocation, {
                                text: results.result[i].userName, 
                                draggable: false, 
                                typeName: results.result[i].id 
                        });
                        map.entities.push(newPin);
                        $('.' + results.result[i].id).children().attr('title', results.result[i].text);
                    }
                }, function (err) {
                    alert("Error: " + err);
                });

                //var query = itemTable.read().done(function (results) {
                //    alert(JSON.stringify(results));
                //}, function (err) {
                //    alert("Error: " + err);
                //});
            }

            function locateFail(geoPositionError) {
                switch (geoPositionError.code) {
                    case 0: //unkown error
                        alert('an unknown error occurred. sorry');
                        break;
                    case 1:
                        alert('permission to use geolocation was denied');
                        break;
                    case 2:
                        alert('the geolocation request took too long and timed out');
                        break;
                    default:
                        break;
                }
            }
            function drawCircle(loc) {
                var radius = 100;
                var R = 6378137;
                var lat = (loc.latitude * Math.PI) / 180;
                var lon = (loc.longitude * Math.PI) / 180;
                var d = parseFloat(radius) / R;
                var locs = new Array();
                for (x = 0; x <= 360; x++) {
                    var p = new Microsoft.Maps.Location();
                    brng = x * Math.PI / 180;
                    p.latitude = Math.asin(Math.sin(lat) * Math.cos(d) + Math.cos(lat) * Math.sin(d) * Math.cos(brng));
                    p.longitude = ((lon + Math.atan2(Math.sin(brng) * Math.sin(d) * Math.cos(lat), Math.cos(d) - Math.sin(lat) * Math.sin(p.latitude))) * 180) / Math.PI;
                    p.latitude = (p.latitude * 180) / Math.PI;
                    locs.push(p);
                }
                return new Microsoft.Maps.Polygon(locs, { fillColor: new Microsoft.Maps.Color(125, 0, 0, 255), strokeColor: new Microsoft.Maps.Color(0, 0, 0, 255) });
            }
        </script>
        <script>
                        if (window.File && window.FileReader && window.FileList && window.Blob) {
                // Great success! All the File APIs are supported.
            } else {
                alert('The File APIs are not fully supported in this browser.');
            }
        </script>
        <script src="http://ajax.aspnetcdn.com/ajax/mobileservices/MobileServices.Web-1.1.3.min.js"></script>
    </head>
    <body onload="GetMap();">
        <div id="mapDiv" style="position:relative; width:800px; height:800px;"></div>

        <style>
            .thumb {
              height: 75px;
              border: 1px solid #000;
              margin: 10px 5px 0 0;
            }
        </style>

        <input type="file" id="files" name="files[]" multiple />
        <br></br>
        <output id="list"></output>
        <script>
            function handleFileSelect(evt)
            {
                var files = evt.target.files; // FileList object

                // Loop through the FileList and render image files as thumbnails.
                for (var i = 0, f; f = files[i]; i++)
                {

                    // Only process image files.
                    if (!f.type.match('image.*'))
                    {
                        continue;
                    }

                    var reader = new FileReader();

                    // Closure to capture the file information.
                    reader.onload = (function (theFile)
                    {
                        return function (e)
                        {
                            // Render thumbnail.
                            var span = document.createElement('span');
                            span.innerHTML = ['<img class="thumb" exif="true" src="', e.target.result,
                                                          '" title="', escape(theFile.name), '"/>'].join('');
                            document.getElementById('list').insertBefore(span, null);
                        };
                    })(f);

                    // Read in the image file as a data URL.
                    reader.readAsDataURL(f);
                }
            }
            document.getElementById('files').addEventListener('change', handleFileSelect, false);
        </script>
    </body>
</html>